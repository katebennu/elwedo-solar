{% load static %}
{% block styles %}
    <link rel="stylesheet" type="text/css" href="{% static 'infographics/timeline.css' %}">{% endblock %}

<h3>Timeline graph test</h3>

<div class="timeline-chart"></div>

{% for i in context_data %}
    <p>{{ i.timestamp }} {{ i.value }}</p>
{% endfor %}



<script>
    var margin = {top: 10, right: 20, bottom: 60, left: 30};
    var width = 400 - margin.left - margin.right;
    var height = 200 - margin.top - margin.bottom;

    // Parse the date / time
    var	parseTime = d3.timeParse("%H-%M");

    var svg = d3.select('.timeline-chart')
        .append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .call(responsivefy)
        .append('g')
        .attr('transform', 'translate(' + margin.left + ', ' + margin.top + ')');

    var data = {{ context_data|safe }};

    d3.json(data, function (error, data) {
        if (error) throw error;
        data.forEach(function (d) {
            d.timestamp = parseTime(d.timestamp);
            d.value = +d.value;
        })
    })

    var yScale = d3.scaleLinear()
        .domain([0, 40])
        .range([height, 0]);
    var yAxis = d3.axisLeft(yScale);
    svg.call(yAxis);

    var xScale = d3.scaleTime()
        .domain([new Date(2016, 5, 15, 1), new Date(2016, 5, 15, 23)])
        .range([0, width]);

    var xAxis = d3.axisBottom(xScale)
        .ticks(data.length)
        .tickSize(10)
        .tickPadding(5)
        .tickFormat(d3.timeFormat("%H"));

    svg
        .append('g')
        .attr('transform', `translate(0, ${height})`)
        .call(xAxis);

    svg.selectAll('rect')
        .data(data)
        .enter()
        .append('rect')
        .attr('x', d.timestamp)

    .attr('y', d.value)
    .attr('width', d)
    .attr('height', d);

    function responsivefy(svg) {
        // get container + svg aspect ratio
        var container = d3.select(svg.node().parentNode),
            width = parseInt(svg.style("width")),
            height = parseInt(svg.style("height")),
            aspect = width / height;

        // add viewBox and preserveAspectRatio properties,
        // and call resize so that svg resizes on inital page load
        svg.attr("viewBox", "0 0 " + width + " " + height)
            .attr("preserveAspectRatio", "xMinYMid")
            .call(resize);

        // to register multiple listeners for same event type,
        // you need to add namespace, i.e., 'click.foo'
        // necessary if you call invoke this function for multiple svgs
        // api docs: https://github.com/mbostock/d3/wiki/Selections#on
        d3.select(window).on("resize." + container.attr("id"), resize);

        // get width of container and resize svg to fit it
        function resize() {
            var targetWidth = parseInt(container.style("width"));
            svg.attr("width", targetWidth);
            svg.attr("height", Math.round(targetWidth / aspect));
        }
    }

</script>